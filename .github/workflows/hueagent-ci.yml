name: HueAgent CI

on:
  pull_request:
    branches: [ main ]
    paths:
      - "modules/HueAgent/**"
      - "deployment*.json"
      - ".github/workflows/hueagent-*.yml"

permissions:
  contents: read
  pull-requests: write

env:
  WORKING_DIR: modules/HueAgent

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Use Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install dependencies
        run: npm install --no-fund --no-audit
        working-directory: ${{ env.WORKING_DIR }}

      - name: Run tests
        run: npm test
        working-directory: ${{ env.WORKING_DIR }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.WORKING_DIR }}
          file: ${{ env.WORKING_DIR }}/Dockerfile.arm64v8
          push: false
          load: true
          tags: hueagent:${{ github.sha }}
          platforms: linux/arm64

      - name: Semantic-release (dry run)
        id: sr_dryrun
        uses: cycjimmy/semantic-release-action@v4
        with:
          working_directory: ${{ env.WORKING_DIR }}
          dry_run: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment dry-run result on PR
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Semantic-release dry run completed.
            - published: ${{ steps.sr_dryrun.outputs.new_release_published || 'false' }}
            - version: ${{ steps.sr_dryrun.outputs.new_release_version || 'n/a' }}
            - note: dry run only; no tags or releases were created.
            [View run logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
