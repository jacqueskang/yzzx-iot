name: HueAgent CI

on:
  pull_request:
    branches: [ main ]
    paths:
      - "modules/HueAgent/**"
      - "deployment*.json"
      - ".github/workflows/hueagent-*.yml"

permissions:
  contents: read
  pull-requests: write

env:
  WORKING_DIR: modules/HueAgent

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Use Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install dependencies
        run: npm install --no-fund --no-audit
        working-directory: ${{ env.WORKING_DIR }}

      - name: Semantic-release (dry run)
        id: sr_dryrun
        uses: cycjimmy/semantic-release-action@v6
        with:
          working_directory: ${{ env.WORKING_DIR }}
          dry_run: true
          ci: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment dry-run result on PR
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üîç Semantic Release Preview (Dry Run)
            
            **Release:** ${{ steps.sr_dryrun.outputs.new_release_published == 'true' && '‚úÖ Will be published' || '‚ùå No release' }}
            ${{ steps.sr_dryrun.outputs.new_release_published == 'true' && format('**Version:** `{0}`', steps.sr_dryrun.outputs.new_release_version) || '' }}
            ${{ steps.sr_dryrun.outputs.new_release_published == 'true' && format('**Tag:** `{0}`', steps.sr_dryrun.outputs.new_release_git_tag) || '' }}
            
            ${{ steps.sr_dryrun.outputs.new_release_published == 'true' && '### üìù Release Notes Preview' || '' }}
            ${{ steps.sr_dryrun.outputs.new_release_published == 'true' && steps.sr_dryrun.outputs.new_release_notes || '_No commits trigger a release based on conventional commit rules._' }}
            
            ---
            _This is a dry run. No tags or releases were created._
            [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Run tests
        run: npm test
        working-directory: ${{ env.WORKING_DIR }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.WORKING_DIR }}
          file: ${{ env.WORKING_DIR }}/Dockerfile.arm64v8
          push: false
          load: true
          tags: hueagent:${{ github.sha }}
          platforms: linux/arm64
